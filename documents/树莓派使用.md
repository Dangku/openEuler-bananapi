# 启用树莓派

版本要求：树莓派 3B/3B+/4B。

默认用户名：root，密码：openeuler。

将刷好的 SD 卡插入树莓派，通电启用。树莓派正常启动，还需连接网线至局域网。

由于使用树莓派时，大多都使用 ssh 远程连接；在树莓派启动联网时，无法得知其 IP 地址。

有以下两种方式：

1. 如果树莓派连接已知路由器，可登录路由器管理，新增的 IP 即为树莓派 IP：

![](images/获取IP.jpg)

2. 将树莓派连接显示器，需注意，树莓派视频输出接口为 Micro HDMI

连接显示器后，直接用户名/密码登录，登录成功后，树莓派即显示本机相关信息，包括本机 IP。如下图（ssh 登录也显示这些信息）：

![](images/登录树莓派.jpg)

# 根目录分区扩展

默认根目录分区空间比较小，在使用之前，需要对分区进行扩容。


## 查看磁盘分区信息

`fdisk -l`

获取 SD 卡磁盘信息，例如 SD 卡对应磁盘为 /dev/mmcblk0。openEuler 镜像包括 3 个分区，分别为

- 引导分区 /dev/mmcblk0p1
- 交换分区 /dev/mmcblk0p2
- 根目录分区 /dev/mmcblk0p3

这里我们需要将根目录分区进行扩容。

## 分区扩容

### 操作磁盘 /dev/mmcblk0

`fdisk /dev/mmcblk0`

### 查看当前分区情况

`p`

记录下分区 /dev/mmcblk0p3 的起始扇区号，这里记为 `xxx`。

### 删除分区 /dev/mmcblk0p3

`d`

### 选择要删除的分区序号

回车（默认为 3）或 输入 `3`

### 创建新的分区

`n`

### 选择创建分区类型

回车（默认为 p）或 输入 `p`

### 选择要创建的分区序号

回车（默认为 3）或 输入 `3`

### 输入新分区的起始扇区号

注意！！！不要直接输入回车或使用默认参数。这是需要输入删除分区 /dev/mmcblk0p3 之前查看到的的起始扇区号。

`xxx`


### 输入新分区的终止扇区号

回车

取默认的最后一个扇区号。

### 是否修改扇区标记

`N`

不修改。

### 保存并退出

`w`

该操作结束后，使用 `fdisk -l` 命令可以看到 /dev/mmcblk0p3 大小已经扩展。但是通过 `df -lh` 可以看到根目录大小没有变化。

### 增大未加载的文件系统大小

`resize2fs /dev/mmcblk0p3`


如果该命令失败，可通过命令 `reboot` 重启树莓派之后再执行 `resize2fs /dev/mmcblk0p3`。

该操作结束后，通过 `df -lh` 可以看到根目录大小已经扩展。

至此，根目录分区扩容结束。扩容过程见下图：

![](images/分区扩容.jpg)

# wifi 连接

## 查看 IP 和网卡信息

`ip a`

获取无线网卡 wlan0 信息：

```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether dc:a6:32:50:de:57 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.108/24 brd 192.168.31.255 scope global dynamic noprefixroute eth0
       valid_lft 41527sec preferred_lft 41527sec
    inet6 fe80::bda0:3318:35ba:7583/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: wlan0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc fq_codel state DOWN group default qlen 1000
    link/ether 7e:f1:16:71:7e:69 brd ff:ff:ff:ff:ff:ff
```

## 扫描可以连接的 wifi 信息

`nmcli dev wifi`

## 连 接wifi

`nmcli dev wifi connect SSID password PWD`

其中，`SSID` 为上一步扫描到的可供连接的 wifi 的 SSID，`PWD` 为对应 wifi 的密码。例如：`nmcli dev wifi connect xxx password yyy`，连接成功：

```
Device 'wlan0' successfully activated with 'dca7d2f4-00af-44e7-8374-13ef5efe1f9a'.
```

## 查看 IP 和无线网卡信息

`ip a`

```
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether dc:a6:32:50:de:57 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.108/24 brd 192.168.31.255 scope global dynamic noprefixroute eth0
       valid_lft 42966sec preferred_lft 42966sec
    inet6 fe80::bda0:3318:35ba:7583/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: wlan0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether dc:a6:32:50:de:58 brd ff:ff:ff:ff:ff:ff
    inet 192.168.1.109/24 brd 192.168.31.255 scope global dynamic noprefixroute wlan0
       valid_lft 43190sec preferred_lft 43190sec
    inet6 fe80::7a67:44e2:b596:fc01/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```

# 音频

## 开启音频

编辑 /boot/config.txt：

`vim /boot/config.txt`

添加内容：

```
dtparam=audio=on
```

重启树莓派。

## 安装音频播放软件

这里以使用 mpg123 为例。

```
dnf install mpg123
```

### 播放音频
`mpg123 xxx.mp3`

### 音频输出配置

详细信息可参考[树莓派官方文档](https://www.raspberrypi.org/documentation/)，如：[audio-config](https://www.raspberrypi.org/documentation/configuration/audio-config.md)。

树莓派有两种音频输出模式：HDMI 和耳机插孔。可以根据需要更换输出模式。

如果您的 HDMI 显示器或电视具有内置扬声器，则可以通过 HDMI 电缆播放音频，但您可以将其切换到耳机或插入耳机插孔的其他扬声器。如果显示器有扬声器，则默认情况下声音通过 HDMI 输出；如果没有，则通过耳机插孔输出。这可能不是所需的输出设置，或者自动检测不准确，在这种情况下，您可以手动切换输出。

可以通过输入命令将音频输出切换到对应模式。

#### HDMI

`amixer cset numid=3 2`

#### 耳机插孔

`amixer cset numid=3 1`

#### 自动（默认）

`amixer cset numid=3 0`

# 蓝牙

## 开启蓝牙

需要保证蓝牙已经开启，例如，如果树莓派启用了串口功能，`/boot/config.txt` 中会有配置项 `dtoverlay=pi3-disable-bt`，使用蓝牙则需要取消该配置项，请删除或注释。如果修改过`/boot/config.txt`的配置内容，需要重启树莓派。

## 查看蓝牙设备

`hciconfig`

例如，这里查看到的信息如下：

```
hci0:   Type: Primary  Bus: UART
        BD Address: AA:AA:AA:AA:AA:AA  ACL MTU: 1021:8  SCO MTU: 64:1
        UP RUNNING
        RX bytes:66475718 acl:151850 sco:0 events:1760 errors:0
        TX bytes:13827 acl:117 sco:0 commands:996 errors:0
```

## 连接蓝牙

使用 `bluetoothctl` 交互命令连接蓝牙设备。

### 进入交互命令

`bluetoothctl`

### 开启控制器电源

`power on`

### 启用代理

`agent on`

### 设置代理为默认代理

`default-agent`

### 扫描

`scan on`

这里看到要连接的蓝牙设备对应的 MAC 地址，记为 `target-MAC`。

### 配对

`pair target-MAC`

### 添加信任

这一步可忽略。

`trust target-MAC`

### 连接

`connect target-MAC`

连接成功，则会在该交互命令界面显示进入到目标蓝牙设备。

这里，可能会出现的问题：

1. Attempting to connect to XX:XX:XX:XX:XX:XX
Failed to connect: org.bluez.Error.Failed

解决：重启 pluseaudio。

```
pulseaudio -k
pulseaudio --start
```
如果重启多次仍然无效。在 `bluetoothctl` 交互命令中删除对应蓝牙设备信息：`remove target-MAC`，然后按照 `pair`、`trust`、`connect` 的过程连接蓝牙。

## 播放音乐

`target-MAC` 对应的设备上`设置->蓝牙`会显示已经连接到树莓派的蓝牙设备。该设备播放音乐，就可以通过树莓派收听。注意，需要保证树莓派已经开启音频。

## 文件传输

### 下载软件 obexftp

```
wget https://rpmfind.net/linux/mageia/distrib/cauldron/aarch64/media/core/release/lib64obexftp0-0.24-17.mga8.aarch64.rpm
wget https://rpmfind.net/linux/mageia/distrib/cauldron/aarch64/media/core/release/lib64openobex1-1.7.2-3.mga8.aarch64.rpm
wget https://rpmfind.net/linux/mageia/distrib/cauldron/aarch64/media/core/release/obexftp-0.24-17.mga8.aarch64.rpm
```
### 安装 obexftp

```
rpm -i lib64obexftp0-0.24-17.mga8.aarch64.rpm
rpm -i lib64openobex1-1.7.2-3.mga8.aarch64.rpm
rpm -i obexftp-0.24-17.mga8.aarch64.rpm
```

### 文件传输

#### 查看文件传输的 channel

`sdptool browse target-MAC`

查看结果：
```
Browsing target-MAC ...
...
Browsing target-MAC ...
Service Search failed: Invalid argument
Service Name: OBEX Phonebook Access Server
Service RecHandle: 0x1000b
Service Class ID List:
  "Phonebook Access - PSE" (0x112f)
Protocol Descriptor List:
  "L2CAP" (0x0100)
  "RFCOMM" (0x0003)
    Channel: 19
  "OBEX" (0x0008)
Profile Descriptor List:
  "Phonebook Access" (0x1130)
    Version: 0x0101

Service Name: OBEX Object Push
Service RecHandle: 0x1000c
Service Class ID List:
  "OBEX Object Push" (0x1105)
Protocol Descriptor List:
  "L2CAP" (0x0100)
  "RFCOMM" (0x0003)
    Channel: 12
  "OBEX" (0x0008)
Profile Descriptor List:
  "OBEX Object Push" (0x1105)
    Version: 0x0102
...
```

看到其中 `Service Name: OBEX Object Push` 下的 ` Channel: 12`。
#### 传输文件

文件路径记为 `file-path`。

`obexftp -b target-MAC -B 12 -U NONE -p file-path`

之后就可以在`target-MAC` 对应的设备上选择接收文件，进行文件传输。